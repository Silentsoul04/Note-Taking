## OSI 参考模型

开放式系统互联通信参考模型（英语：Open System Interconnection Reference Model，缩写为 OSI），简称为OSI模型（OSI model），一种概念模型，将计算机网络体系结构划分为以下七层，每一层都呼叫它的下一层所提供的协议来完成自己的需求。OSI参考模型并没有提供一个可以实现的方法，而是描述了一些概念，用来协调进程间通信标准的制定。即OSI参考模型并不是一个标准，而是一个在制定标准时所使用的概念性框架。

|   OSI层    |                             功能                             |                  协议                   |
| :--------: | :----------------------------------------------------------: | :-------------------------------------: |
|   应用层   |  提供为应用软件而设的接口，以设置与另一应用软件之间的通信。  | HTTP、FTP、DNS、URL、HTML、SMTP、Telnet |
|   表达层   |    把数据转换为能与接收者的系统格式兼容并适合传输的格式。    |                                         |
|   会话层   | 在数据传输中设置和维护计算机网络中两台计算机之间的通信连接。 |                                         |
|   传输层   | 把传输表头（TH）加至数据以形成数据包。传输表头包含了所使用的协议等发送信息。 |                TCP、UDP                 |
|   网络层   | 决定数据的路径选择和转寄，将网络表头（NH）加至数据包，以形成分组。网络表头包含了网络数据。 |              IP、ARP、ICMP              |
| 数据链路层 |                  网络寻址、错误侦测和改错。                  |                 网卡层                  |
|   物理层   |                           物理媒体                           |                  硬件                   |

发送方由 7--->1 从上至下传输数据，接收方则由 1--->7 由下至上传输数据。每个分层上，发送方在处理上一层传过来的数据时，附上当前分层协议的首部信息。接收方再将收到的数据首部和内容分离，继续转发给上一层，最终发送方的数据恢复原状。

* 在应用层写入数据
* 经由表示层格式化编码
* 再由会话层标记发送顺序。会话层只负责建立连接和断开连接的时机，并不具有实际传输数据的功能。
* 传输层进行实际的建立和断开连接处理。在两个主机之间建立逻辑上的通信连接是其主要责任。保证数据传输的可靠性是其重要作用。
* 网络层的作用是在网络互连的环境中，将数据由发送端主机发送到接收端主机。
* 通信传输实际上是通过物理的传输介质实现。数据链路层的作用就是在这些通过传输介质互连的硬件设备之间进行数据处理，负责每一个区间内的通信。

***

## TCP/IP

TCP/IP网络模型四层模型。从根本上和OSI七层网络模型是一样的，只是合并了几层，具体如下：　

![](https://note-taking-1258869021.cos.ap-beijing.myqcloud.com/python/OSI.png)

在TCP/IP协议中，其各层之间的通信机制，大致如下图所示：

![](https://note-taking-1258869021.cos.ap-beijing.myqcloud.com/python/TCP%20IP.png)

IP通常被翻译为网际协议，它服务于网络层，主要实现了寻址和路由的功能。接入网络的每一台主机都需要有自己的IP地址，IP地址就是主机在计算机网络上的身份标识。当然由于IPv4地址的匮乏，平常在家里、办公室以及其他可以接入网络的公共区域上网时获得的IP地址并不是全球唯一的IP地址，而是一个局域网（LAN）中的内部IP地址，通过网络地址转换（NAT）服务，也可以实现对网络的访问。计算机网络上有大量的被称为“路由器”的网络中继设备，它们会存储转发我们发送到网络上的数据分组，让从源头发出的数据最终能够找到传送到目的地通路，这项功能就是所谓的路由。

TCP全称传输控制协议，它是基于IP提供的寻址和路由服务而建立起来的负责实现端到端可靠传输的协议，之所以将TCP称为可靠的传输协议是因为TCP向调用者承诺了三件事情：

* 数据不传丢不传错（利用握手、校验和重传机制可以实现）。
* 流量控制（通过滑动窗口匹配数据发送者和接收者之间的传输速度）。
* 拥塞控制（通过RTT时间以及对滑动窗口的控制缓解网络拥堵）。

***

## 网络应用模式

### C/S模式和B/S模式

这里的C指的是Client（客户端），通常是一个需要安装到某个宿主操作系统上的应用程序；而B指的是Browser（浏览器），它几乎是所有图形化操作系统都默认安装了的一个应用软件；通过C或B都可以实现对S（服务器）的访问。

服务器拾一系列的硬件或软件，为客户端提供所需服务。服务器的目的就是：等待客户端的请求，并响应，然后等待接下来的请求。会有以下分类：

* 硬件客户端/服务器：打印服务器、文件服务器
* 软件客户端/服务器：Web服务器、数据库服务器

### 去中心化的网络应用模式

不管是B/S还是C/S都需要服务器的存在，服务器就是整个应用模式的中心，而去中心化的网络应用通常没有固定的服务器或者固定的客户端，所有应用的使用者既可以作为资源的提供者也可以作为资源的访问者。

***

## 基于HTTP协议的网络资源访问

### HTTP（超文本传输协议）

HTTP是超文本传输协议（Hyper-Text Transfer Proctol）的简称，维基百科上对HTTP的解释是：超文本传输协议是一种用于分布式、协作式和超媒体信息系统的应用层协议，它是万维网数据通信的基础，设计HTTP最初的目的是为了提供一种发布和接收HTML页面的方法，通过HTTP或者HTTPS（超文本传输安全协议）请求的资源由URI（统一资源标识符）来标识。

HTTP 是基于 TCP/IP 协议的应用层协议。它不涉及数据包（packet）传输，主要规定了客户端和服务器之间的通信格式，默认使用80端口。

简单的说，通过HTTP我们可以获取网络上的（基于字符的）资源，开发中经常会用到的网络API（有的地方也称之为网络数据接口）就是基于HTTP来实现数据传输的。

### requests 库

requests是一个基于HTTP协议来使用网络的第三库。简单的说，使用requests库可以非常方便的使用HTTP，避免安全缺陷、冗余代码以及“重复发明轮子”。

***

## 基于传输层协议的套接字编程

在服务器响应客户端请求之前，必须执行一系列流程，从而为后来的工作做准备。首先会创建一个通信端口，由此服务器会一直监听请求。位于传输层的通信协议通常需要指定端口号。

在计算机网络中，通信端口（英语：port），又称为通信端口、端口、协议端口（protocol port），是一种经由软件创建的服务，在一个计算机操作系统中扮演通信的端点（endpoint）。每个通信端口都会与主机的IP地址及通信协议关联。通信端口以16比特数字来表示，这被称为通信端口编号（port number）。 

在操作系统上运行的网络软件，可以透过操作系统，利用各个不同的通信端口，将数据发送到网络上；操作系统也可以根据数据包的IP地址以及端口号，将这些数据包转送到匹配的进程去。在操作系统中，一个进程，可以通过internet socket，将它的输入与输出，与一个特定的传输协议，一个通信端口，与IP地址，关系起来。这个关系动作，称为绑定（binding），在这之后，就可以通过网络提交与接收数据。

虽然使用同样传输协议，但是特定的IP地址以及通信端口的组合，只会被绑定到单一的特定进程上。当使用同样协议的多个程序，尝试着绑定在同一个IP地址下的相同通信端口，就会产生一个常见的应用程序错误，这个错误有时候被称为通信端口冲突（port conflicts）。 

### 通信端口类型

传输层协议，如传输控制协议（TCP）与用户数据报文协议（UDP），在分组表头中，定义了来源端口号与目的端口号。一个通信端口号使用16位无符号整数（unsigned integer）来表示，其范围介于0与65535之间。在TCP协议中，端口号0是被保留的，不可使用。分为3类：

* 1--1023：系统保留，只能由root用户使用。
* 1024---4999：由客户端程序自由分配。
* 5000---65535：由服务器端程序自由分配在UDP协议中，来源端口号是可以选择要不要填上，如果设为0，则代表没有来源端口号。

### 通信端口用途

端口号有2种用途： 

* 标识服务器上提供特定网络服务的进程。客户机可以按照服务器IP与端口号与相应的服务器进程创建网络连接，获得相应的网络服务。例如，通常使用80端口号提供http服务，使用23端口号telnet服务。服务器的这种功能叫做listening。客户机通常使用动态指定的端口号与服务器创建连接。
* 由本机地址、本机端口号、目标机地址、目标机端口号、通信协议组成的五元组，用于唯一确定正在使用的网络链接。因此，对于不同的协议、不同的目标机地址，本机的不同地址（如果本机使用多个网卡）等多种情形，同一个端口号可以复用。因此对于1对1通信，且本机与目标机之间只能创建一个通信连接，则不需要使用端口号。

网络防火墙或者网关还可提供端口转发（port forwarding），即NAT。 

### 套接字

套接字体现了通信端口的概念。

在计算机科学中，网络套接字（英语：Network socket），又译网络套接字、网络接口、网络插槽，是计算机网络中进程间数据流的端点。使用以网际协议（Internet Protocol）为通信基础的网络套接字，称为网际套接字（Internet socket）。因为网际协议的流行，现代绝大多数的网络套接字，都是属于网际套接字。

socket 是一种操作系统提供的进程间通信机制。进程通信之前，双方首先必须各自创建一个端点，否则是没有办法建立通信。

下图选自《图解TCP/IP》:

![SOCKET](https://note-taking-1258869021.cos.ap-beijing.myqcloud.com/python/socket%20TCPIP.png)

在操作系统中，通常会为应用程序提供一组应用程序接口（API），称为套接字接口（英语：socket API）。应用程序可以通过套接字接口，来使用网络套接字，以进行数据交换。

在套接字接口中，以IP地址及通信端口组成套接字地址（socket address）。远程的套接字地址，以及本地的套接字地址完成连线后，再加上使用的协议（protocol），这个五元组（five-element tuple），作为套接字对（socket pairs），之后就可以彼此交换数据。例如，在同一台计算机上，TCP协议与UDP协议可以同时使用相同的port而互不干扰。 操作系统根据套接字地址，可以决定应该将数据送达特定的进程或线程。

网络中每个通信实体的 socket 是由一个三元组标识。通信双方之间的一个完整连接是用五元组标识，它是由双方的三元组合成的。五元组往往称为全相关，而三元组往往称为半相关。

要通过 Internet 进行通信，至少需要一对套接字，其中一个运行在客户端，称之为 ClientSocket，另一个运行于服务器端面，称为 ServerSocket。根据连接启动的方式以及本地要连接的目标，套接字之间的连接过程可以分为三个步骤：服务器监听、客户端请求、连接确认。

套接字分为两种：

* 网络：AF_INET（IPv4网络协议）、AF_INET6（IPv6网络协议），广泛用于互联网编程，包括了IP地址和TCP、UDP端口号。
* 本地：AF_UNIX（Unix 域套接字），运行在同一台计算机上的程序间的本地通信，不用于网络通讯。

除此之外，无论使用哪种地址家族的套接字也可以如下分为2类：

* 面向连接：
  * 在进行通信之前必须建立起一个连接。
  * 使用流套接字（SOCK_STREAM）。实现这种连接类型的协议主要是 TCP。
* 无连接：
  * 在进行通信之前不需要建立连接。
  * 使用数据报文套接字（SOCK_DGRAM）。实现这种连接类型的协议主要是 UDP。

**进程间通信**（IPC，Inter-Process Communication），指至少两个进程或线程间传送数据或信号的一些技术或方法。 进程是计算机系统分配资源的最小单位(严格说来是线程)。每个进程都有自己的一部分独立的系统资源，彼此是隔离的。为了能使不同的进程互相访问资源并进行协调工作，才有了进程间通信。通常，使用进程间通信的两个应用可以被分为客户端和服务器（见主从式架构），客户端进程请求数据，服务端响应客户端的数据请求。有一些应用本身既是服务器又是客户端，这在分布式计算中，时常可以见到。这些进程可以运行在同一计算机上或网络连接的不同计算机上。 

**应用程序接口**（英语：application programming interface，缩写作 API），又称为应用编程接口，就是软件系统不同组成部分衔接的约定。由于近年来软件的规模日益庞大，常常需要把复杂的系统划分成小的组成部分，编程接口的设计十分重要。程序设计的实践中，编程接口的设计首先要使软件系统的职责得到合理划分。良好的接口设计可以降低系统各部分的相互依赖，提高组成单元的内聚性，降低组成单元间的耦合程度，从而提高系统的可维护性和可扩展性。 

**三元组**可以在全局标识唯一的进程：（协议，本地地址，本地端口号）。

**五元组**：一个完整的进程通信由两个进程组成，并且只能使用同一种协议。因此一个完整的通信需要一个五元组来标识：（协议，本地地址，本地端口号，远地地址，远地端口号）。

**TCP 与 UDP 区别**：

* TCP 是面向连接的、可靠的流协议。流就是指不间断的数据结构。提供可靠性传输，实行“顺序控制”或“重发控制”，此外还具有“流控制”、“拥塞控制”等功能。
* UDP 是面向无连接、不具有可靠性的数据报协议。虽然可以确保数据的大小，却不能保证数据会到达。细微的处理交由上层的应用去完成。主要用于对告诉传输和实时性要求较高的通信或广播通信。

***

参考：

[网络套接字](https://zh.wikipedia.org/wiki/%E7%B6%B2%E8%B7%AF%E6%8F%92%E5%BA%A7#cite_note-1)，wiki

[通信端口](https://zh.wikipedia.org/wiki/%E9%80%9A%E8%A8%8A%E5%9F%A0)，wiki

[网络编程](http://www.liujiangblog.com/course/python/75)，刘江

[网络编程入门](https://github.com/jackfrued/Python-100-Days/blob/master/Day01-15/14.%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%E5%85%A5%E9%97%A8%E5%92%8C%E7%BD%91%E7%BB%9C%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91.md)，骆昊